# 2026-02-06 작업 로그

## 세션 1: 데미지 계산 수정 및 기능 추가

### 1. WekBonusDmgPerHit 구현
- `DamageCalculator.cs`에서 `WekBonusDmgPerHit` 로직 추가 (CriBonusDmgPerHit과 동일 방식)
- 여포 혈풍벽파/적토질풍격에 적용

### 2. FoolhardyBravery (용이무모) 버프 추가
- 여포 패시브 파티버프: `FoolhardyBravery = 31`
- BuffSet에 별도 필드로 추가 (Atk_Rate와 다른 버프명이므로 MaxMerge 독립)
- Add, MaxMerge, Clone, Clear, implicit operator 모두 반영
- StatCalculator에서 공격력 계산 시 Atk_Rate와 합산

### 3. MarkAttack (표식 공격) 모델 생성
- 여포 패시브 "방천화극의 분노" 구현
- MarkAttack 클래스: MaxStacks, AtkCount, Ratio, TargetMaxHpRatio
- CalcMarkDamage 메서드 추가 (CalcCoopDamage 패턴)
- 스킬 결과에 표식 데미지 출력

### 4. 버프 적용 방식 수정 (곱연산 → 합연산)
- StatCalculator: 공/방/체 버프 적용을 곱연산에서 합연산으로 변경
- 변경 전: `(1 + permanent%) × (1 + (timed+pet)%)`
- 변경 후: `1 + (permanent + timed + pet)%`
- 공격력계산식.xlsx와 대조하여 검증 완료

### 5. ExtraDmgMultiplier 수정
- 조건부 추가피해에 n인기피증 적용되도록 변경
- ExtraDmgMultiplier = multiplier (전체 피증 계수와 동일)

### 6. 에스파다 데미지 오차 수정 (Mark_Purify 자버프 타입피증 인식)
- 문제: GetSelfBuffTypeDmg가 Dmg_Dealt_Type만 체크, Mark_Purify 미포함
- 에스파다 마력정화(Mark_Purify=40)가 자버프 타입피증으로 인식 안 됨
- 스택소모 스킬의 SkillDmgMultiplier 분리가 작동하지 않아 스킬피해 과다 계산
- 수정: GetSelfBuffTypeDmg에 Mark_Energeia, Mark_Purify 추가
- 결과: 2,841,078 → 2,733,822 (인게임 2,733,907, 오차 0.003%)

### 7. UI 버프 리스트에 캐릭터 추가
- 여포: 패시브(용이무모), 혈풍벽파(방관@6초), 혈풍벽파(방깎@2초)
- 소교: 호접지몽(공증,치피@6초), 호접지몽(취약)
- 빅토리아: 패시브(댐감@2초), 사기 진작(공증), 권총 사격(취약)

### 8. 셋팅 비교 UI 간소화
- 1번/2번 셋팅 차이 비교(차이값, 퍼센트, 더 높음 표시) 제거
- 두 셋팅의 데미지 결과만 나란히 표시

### 9. 프리셋 슬롯별 분리
- PresetManager 생성자에 파일명 파라미터 추가
- 1번 슬롯: `presets_1.json`, 2번 슬롯: `presets_2.json`
- 슬롯 전환 시 프리셋 리스트 자동 갱신
- 기존 `presets.json` → `presets_1.json` 자동 마이그레이션

## 세션 2: 라이언 광풍참 잃은HP 비례 피해 구현

### 1. 라이언 광풍참 데미지 오차 조사
- 계산기: 310,696 vs 인게임: 414,444
- 원인: "잃은 생명력 비례 최대 50%" 피해증가가 미적용

### 2. 잃은HP 비례 피해 구현 (특정조건 체크 방식)
- 처음 시도: LostHpPercentage(double) + 텍스트박스 입력 → 사용자 거부
- 최종: 특정조건(chkMySkillCondition) 체크 시 자동 적용
- `IsLostHpConditionMet`을 `chkMySkillCondition`에 연결

### 3. SkillDmgMultiplier 버그 수정
- 문제: CalcBaseDamage가 `SkillDmgMultiplier`를 사용하는데 잃은HP 보너스가 `DamageMultiplier`에만 적용됨
- 수정: 잃은HP 보너스를 `SkillDmgMultiplier`와 `DamageMultiplier` 모두에 적용

### 4. LostHpAssumedRemaining 필드 추가
- `SkillLevelData`에 `LostHpAssumedRemaining` 필드 추가
- 특정조건 체크 시 대상 잔여HP% 기준으로 비례 계산
- 라이언 광풍참: `LostHpAssumedRemaining = 30` (30% 남음 → 70% 손실 → 35% 보너스)
- 계산: 310,696 × 1.35 = 419,440 (인게임 414,444, 오차 ~1.2%)
- 정확히 414,444 맞추려면 33.4% 보너스 필요 (잔여HP 33.2%)

### 5. 체력조건 체크박스 복원
- 체력조건은 강포15단계 체력30% 이상 시 방증40% 용도 (별도 기능)
- 특정조건과 별개로 XAML에 복원, 프리셋 저장/로드도 복원

### 6. 지크 패시브 버프 처리 확인
- 지크 ConditionalPartyBuff → GetTimedPassiveBuffs() → 턴제 버프 MaxMerge (정상)
- 지속버프가 아닌 턴제 버프로 올바르게 처리됨

## 세션 3: 라이언 잃은HP 보너스 보정, 소교 타수 수정, 엑셀 검증

### 1. 소교 우후죽순 타수 수정
- 계산기 93,635 vs 인게임 46,213 (정확히 2배)
- 원인: Atk_Count = 2 → 사용자가 직접 1로 수정

### 2. 공격력계산식.xlsx 검증
- 공격력, 방어계수, 치명/약점/취약: 계산기와 일치 ✅
- **피증계수 오류 발견**: `*E6` → `*(1+E6)` 수정 필요 (기본 100% 누락)
- 방어상수: 0.00214 vs 1/467 (미세 오차, 무시 가능)

### 3. 라이언 LostHpAssumedRemaining 보정 (30 → 0)
- 버프 중복 문제 발견: 캐릭터 선택 시 패시브 자버프 + UI 버프 리스트 중복 체크
- 중복 제거 후 역산: 414,444 / 276,297 = ×1.50 → 잃은HP 보너스 정확히 50% (최대)
- 보스 HP가 기믹으로 최저치 고정 → 게임이 "잃은HP = 100%"로 판정
- LostHpAssumedRemaining = 0 (>0 조건 불충족 → LostHpBonusDmgMax 그대로 반환)

## 📋 오늘 작업 요약
- 여포 캐릭터 패시브 시스템 완성 (FoolhardyBravery, MarkAttack, WekBonusDmgPerHit)
- 버프 합연산 방식 수정으로 공격력 계산 정확도 개선
- 에스파다 Mark_Purify 자버프 타입피증 인식 버그 수정 (오차 3.9% → 0.003%)
- n인기피증이 조건부 추가피해에 적용되도록 수정
- UI 버프 리스트에 소교/빅토리아/여포 추가
- 셋팅 비교 출력 간소화
- 프리셋 슬롯별 분리 (1번/2번 각각 독립 프리셋 리스트)
- 라이언 광풍참 잃은HP 비례 피해 구현 및 보정 (50% 최대 보너스, 인게임 일치)
- SkillDmgMultiplier 버그 수정 (잃은HP 보너스 미적용 문제)
- 체력조건 체크박스 복원 (강포15단계 방증40% 용도)
- 공격력계산식.xlsx 피증계수 오류 발견 (`*E6` → `*(1+E6)`)
