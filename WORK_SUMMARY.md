# 세나리 데미지 계산기 - 작업 요약 (2026-01-30)

## 프로젝트 개요
게임 데미지 계산기 - 인게임 데미지와 일치하도록 공식 수정 중

---

## 오늘 수정한 핵심 공식들

### 1. 버프 계산 방식: 곱연산 → 합연산
**파일**: `Services/StatCalculator.cs` (라인 301-305)

**기존 (잘못됨)**:
```csharp
// 곱연산: (1 + 지속/100) × (1 + 턴제/100)
// 33% + 33% = 1.33 × 1.33 = 1.7689
```

**수정 (정확함)**:
```csharp
// 합연산: (1 + (지속 + 턴제)/100)
// 33% + 33% = 1 + 0.66 = 1.66
result.FinalAtk = preBuffAtk * (1 + (permanentAtkRate + timedAtkRate) / 100.0);
```

**버프 중복 규칙**:
- 지속 버프끼리 Max 처리
- 턴제 버프끼리 Max 처리
- 그 후 지속 + 턴제 합연산

---

### 2. 치명타 계수 공식
**파일**: `Services/DamageCalculator.cs` (라인 174)

```csharp
// 치피% / 100 (1을 더하지 않음!)
// 150% → 1.5x (NOT 1 + 1.5 = 2.5x)
result.CritMultiplier = input.IsCritical ? (inputCritDmg + skillCritDmg) / 100.0 : 1.0;
```

---

### 3. 약점 계수 공식 (최종 확정 ✓)
**파일**: `Services/DamageCalculator.cs` (라인 177-181)

```csharp
// 약점 공식: 약피% / 100 (단순 곱연산)
// 예: 130% → 1.30x, 153% → 1.53x
result.WeakpointMultiplier = input.IsWeakpoint ? input.WeakpointDmg / 100.0 : 1.0;
```

**테스트 결과**:
- 약피 130% (기본): 계산기 19,986 vs 인게임 19,986 ✓
- 약피 153% (미호 +23%): 정상 작동 ✓

---

### 4. 타입피증 공식 (최종 확정 ✓)
**파일**: `Services/DamageCalculator.cs`

```csharp
// 타입피증 공식: 1 + 타입피증% / 100
// 예: 17% → 1.17x
result.TypeDmgMultiplier = 1 + input.TypeDmgIncrease / 100.0;
```

**테스트 결과**:
- 키리엘 타입피증 17%: 정상 작동 ✓

---

### 5. 진형 보너스
**파일**: `Services/StatCalculator.cs` (라인 284-285)

```csharp
// 진형은 기초공에만 적용 (스탯창에는 표시 안됨)
double separateBonusAtk = baseAtk * (formationAtkRate + input.PetOptionAtkRate) / 100.0;
```

---

## 테스트용 캐릭터 설정 (유리)

검증에 사용한 기본 설정:
- 캐릭터: 유리 (희귀 마법형)
- 초월: 12단계
- 기초공: 1389
- 장비깡공: 304 × 2 = 608
- 장비부옵 공%: 20%
- 초월 공%: 39%
- 진형 공%: 42%
- 버프: 데이지 지속 27% + 턴제 33%
- 스킬: 정기 흡수 (배율 340%)

---

## 검증된 테스트 결과

| 테스트 | 계산기 | 인게임 | 오차 |
|--------|--------|--------|------|
| 치명만 (150%) | 21,124 | 21,123 | 0% ✓ |
| 치명+진형 | 25,882 | 25,884 | 0% ✓ |
| 약점만 (130%) | 19,986 | 19,986 | 0% ✓ |
| 약점 153% + 타입피증 17% | 33,110 | 33,108 | 0.006% ✓ |

---

## 해결된 이슈 ✓

### 1. 미호 약점 버프 - 해결됨 ✓
- 약피 153% (130% + 미호 23%) → 1.53x로 정상 계산
- 약점 공식이 단순 약피%/100 임을 확인

### 2. 타입피증 - 해결됨 ✓
- 키리엘 17% → 1.17x로 정상 계산
- 약점과 타입피증은 곱연산으로 적용

---

## 남은 작업 / 확인 필요

### 1. 파스칼 자버프 오차
- 파스칼 테스트 시 약 7-10% 오차 발생
- 자버프 처리 방식 확인 필요

---

## 주요 파일 구조

```
Services/
├── StatCalculator.cs    - 스탯 계산 (버프, 진형 등)
├── DamageCalculator.cs  - 데미지 계산 (치명타, 약점 등)
├── BuffCalculator.cs    - 버프/디버프 수집

DB/
├── CharacterDB.cs       - 캐릭터 데이터
├── SetDB.cs            - 세트 효과
├── PetDb.cs            - 펫 데이터

Models/
├── Formation.cs        - 진형 모델
├── BuffSet.cs          - 버프 모델
```

---

## 핵심 공식 요약

```
최종공격력 = (스탯공격력 + 기초공 × 진형%) × (1 + 지속버프% + 턴제버프%)

데미지 = 공격력 / 방어계수 × 스킬배율 × 치명계수 × 약점계수 × 타입피증계수

치명계수 = 치피% / 100
약점계수 = 약피% / 100
타입피증계수 = 1 + 타입피증% / 100
```
